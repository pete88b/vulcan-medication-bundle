---

title: Per-Patient


keywords: fastai
sidebar: home_sidebar

summary: "Create a FHIR bundle of medications for a single patient."
description: "Create a FHIR bundle of medications for a single patient."
nb_path: "10_per_patient.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 10_per_patient.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Required-resources?">Required resources?<a class="anchor-link" href="#Required-resources?"> </a></h2><p>The CM tab (<a href="https://wiki.cdisc.org/display/FHIR2CDISCUG/FHIR+to+CDISC+Mapping+User+Guide+Home">https://wiki.cdisc.org/display/FHIR2CDISCUG/FHIR+to+CDISC+Mapping+User+Guide+Home</a> FHIR-to-CDISC Mappings xlsx) lists the following resources;</p>
<ul>
<li><del><code>ResearchSubject</code> with <code>ResearchStudy</code></del> NOT YET?</li>
<li><code>Subject</code></li>
<li><code>MedicationStatement</code></li>
<li><code>MedicationRequest</code></li>
<li><code>MedicationDispense</code></li>
<li><code>MedicationAdministration</code></li>
<li><del><code>Immunization</code></del> don't think we're doing immunization yet?</li>
<li><code>Medication</code> referenced by <code>medicationReference</code></li>
<li><code>Condition</code> or <code>Observation</code> referenced by <code>reasonReference</code></li>
</ul>
<p>TODO: For now, I'm just pulling the resources that Jay highlighted as required - we can easily add the others (o:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">requests</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">api_base</span><span class="p">,</span> <span class="n">patient_id</span> <span class="o">=</span> <span class="s1">&#39;https://r4.smarthealthit.org&#39;</span><span class="p">,</span> <span class="s1">&#39;11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bundle</span> <span class="o">=</span> <span class="n">get_as_raw_json</span><span class="p">(</span><span class="n">api_base</span><span class="p">,</span> <span class="s1">&#39;MedicationRequest&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">patient_id</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Patient&#39;</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bundle</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]),</span> <span class="s1">&#39;MedicationRequest resources&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>GET https://r4.smarthealthit.org/MedicationRequest?_format=json&amp;subject=11f2b925-43b2-45e4-ac34-7811a9eb9c1b
Patient 11f2b925-43b2-45e4-ac34-7811a9eb9c1b has 10 MedicationRequest resources
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># bundle</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-and-save-a-single-patient-medication-bundle">Create and save a single patient medication bundle<a class="anchor-link" href="#Create-and-save-a-single-patient-medication-bundle"> </a></h2><p>TODO: extract ref for <code>statusReasonReference</code> - see <a href="https://www.hl7.org/fhir/medicationdispense.html?">https://www.hl7.org/fhir/medicationdispense.html?</a> maybe</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_single_patient_medication_bundle" class="doc_header"><code>create_single_patient_medication_bundle</code><a href="https://github.com/pete88b/vulcan_medication_bundle/tree/main/vulcan_medication_bundle/per_patient.py#L12" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_single_patient_medication_bundle</code>(<strong><code>api_base</code></strong>, <strong><code>patient_id</code></strong>)</p>
</blockquote>
<p>Return a Bundle containing one Patient and any number of MedicationX resources</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bundle</span> <span class="o">=</span> <span class="n">create_single_patient_medication_bundle</span><span class="p">(</span><span class="n">api_base</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">)</span>
<span class="n">bundle</span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>GET https://r4.smarthealthit.org/Patient?_format=json&amp;_id=11f2b925-43b2-45e4-ac34-7811a9eb9c1b
GET https://r4.smarthealthit.org/MedicationRequest?_format=json&amp;subject=Patient%2F11f2b925-43b2-45e4-ac34-7811a9eb9c1b
GET https://r4.smarthealthit.org/MedicationDispense?_format=json&amp;subject=Patient%2F11f2b925-43b2-45e4-ac34-7811a9eb9c1b
GET https://r4.smarthealthit.org/MedicationAdministration?_format=json&amp;subject=Patient%2F11f2b925-43b2-45e4-ac34-7811a9eb9c1b
GET https://r4.smarthealthit.org/MedicationStatement?_format=json&amp;subject=Patient%2F11f2b925-43b2-45e4-ac34-7811a9eb9c1b
GET https://r4.smarthealthit.org/Condition/9a459588-d2e2-4f83-8155-327757db91ed?_format=json
GET https://r4.smarthealthit.org/Condition/7446b6f9-7cc2-4692-8f5e-31e0de1b1a86?_format=json
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;resourceType&#39;: &#39;Bundle&#39;,
 &#39;id&#39;: &#39;592c83b5-ffb6-4cb2-b4ce-0476aa54f091&#39;,
 &#39;type&#39;: &#39;collection&#39;,
 &#39;timestamp&#39;: &#39;2021-09-16T12:46:57Z&#39;,
 &#39;entry&#39;: [{&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;Patient&#39;,
    &#39;id&#39;: &#39;11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T02:56:50.506-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;text&#39;: {&#39;status&#39;: &#39;generated&#39;,
     &#39;div&#39;: &#39;&lt;div xmlns=&#34;http://www.w3.org/1999/xhtml&#34;&gt;Generated by &lt;a href=&#34;https://github.com/synthetichealth/synthea&#34;&gt;Synthea&lt;/a&gt;.Version identifier: v2.4.0-100-g26a4b936\n .   Person seed: -4773009115611363560  Population seed: 1559319163074&lt;/div&gt;&#39;},
    &#39;extension&#39;: [{&#39;url&#39;: &#39;http://hl7.org/fhir/us/core/StructureDefinition/us-core-race&#39;,
      &#39;extension&#39;: [{&#39;url&#39;: &#39;ombCategory&#39;,
        &#39;valueCoding&#39;: {&#39;system&#39;: &#39;urn:oid:2.16.840.1.113883.6.238&#39;,
         &#39;code&#39;: &#39;2028-9&#39;,
         &#39;display&#39;: &#39;Asian&#39;}},
       {&#39;url&#39;: &#39;text&#39;, &#39;valueString&#39;: &#39;Asian&#39;}]},
     {&#39;url&#39;: &#39;http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity&#39;,
      &#39;extension&#39;: [{&#39;url&#39;: &#39;ombCategory&#39;,
        &#39;valueCoding&#39;: {&#39;system&#39;: &#39;urn:oid:2.16.840.1.113883.6.238&#39;,
         &#39;code&#39;: &#39;2186-5&#39;,
         &#39;display&#39;: &#39;Not Hispanic or Latino&#39;}},
       {&#39;url&#39;: &#39;text&#39;, &#39;valueString&#39;: &#39;Not Hispanic or Latino&#39;}]},
     {&#39;url&#39;: &#39;http://hl7.org/fhir/StructureDefinition/patient-mothersMaidenName&#39;,
      &#39;valueString&#39;: &#39;Aisha Schoen&#39;},
     {&#39;url&#39;: &#39;http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex&#39;,
      &#39;valueCode&#39;: &#39;M&#39;},
     {&#39;url&#39;: &#39;http://hl7.org/fhir/StructureDefinition/patient-birthPlace&#39;,
      &#39;valueAddress&#39;: {&#39;city&#39;: &#39;Pepperell&#39;,
       &#39;state&#39;: &#39;Massachusetts&#39;,
       &#39;country&#39;: &#39;US&#39;}},
     {&#39;url&#39;: &#39;http://synthetichealth.github.io/synthea/disability-adjusted-life-years&#39;,
      &#39;valueDecimal&#39;: 13.100670744012936},
     {&#39;url&#39;: &#39;http://synthetichealth.github.io/synthea/quality-adjusted-life-years&#39;,
      &#39;valueDecimal&#39;: 65.89932925598707}],
    &#39;identifier&#39;: [{&#39;system&#39;: &#39;https://github.com/synthetichealth/synthea&#39;,
      &#39;value&#39;: &#39;b200e2a2-c5ea-481f-97ae-67ec2dc22a5b&#39;},
     {&#39;type&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/v2-0203&#39;,
         &#39;code&#39;: &#39;MR&#39;,
         &#39;display&#39;: &#39;Medical Record Number&#39;}],
       &#39;text&#39;: &#39;Medical Record Number&#39;},
      &#39;system&#39;: &#39;http://hospital.smarthealthit.org&#39;,
      &#39;value&#39;: &#39;b200e2a2-c5ea-481f-97ae-67ec2dc22a5b&#39;},
     {&#39;type&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/v2-0203&#39;,
         &#39;code&#39;: &#39;SS&#39;,
         &#39;display&#39;: &#39;Social Security Number&#39;}],
       &#39;text&#39;: &#39;Social Security Number&#39;},
      &#39;system&#39;: &#39;http://hl7.org/fhir/sid/us-ssn&#39;,
      &#39;value&#39;: &#39;999-66-8847&#39;},
     {&#39;type&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/v2-0203&#39;,
         &#39;code&#39;: &#39;DL&#39;,
         &#39;display&#39;: &#34;Driver&#39;s License&#34;}],
       &#39;text&#39;: &#34;Driver&#39;s License&#34;},
      &#39;system&#39;: &#39;urn:oid:2.16.840.1.113883.4.3.25&#39;,
      &#39;value&#39;: &#39;S99982910&#39;},
     {&#39;type&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/v2-0203&#39;,
         &#39;code&#39;: &#39;PPN&#39;,
         &#39;display&#39;: &#39;Passport Number&#39;}],
       &#39;text&#39;: &#39;Passport Number&#39;},
      &#39;system&#39;: &#39;http://standardhealthrecord.org/fhir/StructureDefinition/passportNumber&#39;,
      &#39;value&#39;: &#39;X69901657X&#39;}],
    &#39;name&#39;: [{&#39;use&#39;: &#39;official&#39;,
      &#39;family&#39;: &#39;Connelly&#39;,
      &#39;given&#39;: [&#39;Loyd&#39;],
      &#39;prefix&#39;: [&#39;Mr.&#39;]}],
    &#39;telecom&#39;: [{&#39;system&#39;: &#39;phone&#39;, &#39;value&#39;: &#39;555-238-2967&#39;, &#39;use&#39;: &#39;home&#39;}],
    &#39;gender&#39;: &#39;male&#39;,
    &#39;birthDate&#39;: &#39;1932-06-09&#39;,
    &#39;deceasedDateTime&#39;: &#39;2012-06-16T06:29:54+00:00&#39;,
    &#39;address&#39;: [{&#39;extension&#39;: [{&#39;url&#39;: &#39;http://hl7.org/fhir/StructureDefinition/geolocation&#39;,
        &#39;extension&#39;: [{&#39;url&#39;: &#39;latitude&#39;, &#39;valueDecimal&#39;: 42.535183},
         {&#39;url&#39;: &#39;longitude&#39;, &#39;valueDecimal&#39;: -71.105423}]}],
      &#39;line&#39;: [&#39;329 Ondricka Trafficway&#39;],
      &#39;city&#39;: &#39;Reading&#39;,
      &#39;state&#39;: &#39;Massachusetts&#39;,
      &#39;postalCode&#39;: &#39;01801&#39;,
      &#39;country&#39;: &#39;US&#39;}],
    &#39;maritalStatus&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/v3-MaritalStatus&#39;,
       &#39;code&#39;: &#39;M&#39;,
       &#39;display&#39;: &#39;M&#39;}],
     &#39;text&#39;: &#39;M&#39;},
    &#39;multipleBirthBoolean&#39;: False,
    &#39;communication&#39;: [{&#39;language&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;urn:ietf:bcp:47&#39;,
         &#39;code&#39;: &#39;en-US&#39;,
         &#39;display&#39;: &#39;English&#39;}],
       &#39;text&#39;: &#39;English&#39;}}]},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/MedicationRequest/23bf14fe-78a7-471e-8709-e6e05c2fb70a&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;MedicationRequest&#39;,
    &#39;id&#39;: &#39;23bf14fe-78a7-471e-8709-e6e05c2fb70a&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T03:09:53.333-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;status&#39;: &#39;active&#39;,
    &#39;intent&#39;: &#39;order&#39;,
    &#39;medicationCodeableConcept&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://www.nlm.nih.gov/research/umls/rxnorm&#39;,
       &#39;code&#39;: &#39;198031&#39;,
       &#39;display&#39;: &#39;24hr nicotine transdermal patch&#39;}],
     &#39;text&#39;: &#39;24hr nicotine transdermal patch&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/78b3b752-c513-429b-8653-65527506715e&#39;},
    &#39;authoredOn&#39;: &#39;1992-03-26T06:29:54+00:00&#39;,
    &#39;requester&#39;: {&#39;reference&#39;: &#39;Practitioner/e34619ed-fc04-401f-a94c-1cf43395f4b3&#39;}},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/MedicationRequest/529fc361-5381-42b5-b7d6-10b4dbeacfda&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;MedicationRequest&#39;,
    &#39;id&#39;: &#39;529fc361-5381-42b5-b7d6-10b4dbeacfda&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T03:07:17.732-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;status&#39;: &#39;active&#39;,
    &#39;intent&#39;: &#39;order&#39;,
    &#39;medicationCodeableConcept&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://www.nlm.nih.gov/research/umls/rxnorm&#39;,
       &#39;code&#39;: &#39;1860480&#39;,
       &#39;display&#39;: &#39;1 ML DOCEtaxel 20 MG/ML Injection&#39;}],
     &#39;text&#39;: &#39;1 ML DOCEtaxel 20 MG/ML Injection&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/17cfc6f6-d19f-4624-a04f-835114b8b1a3&#39;},
    &#39;authoredOn&#39;: &#39;2004-05-28T06:29:54+00:00&#39;,
    &#39;requester&#39;: {&#39;reference&#39;: &#39;Practitioner/e34619ed-fc04-401f-a94c-1cf43395f4b3&#39;}},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/MedicationRequest/81c3a0a2-b1e4-4211-9f18-fda5b90d6713&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;MedicationRequest&#39;,
    &#39;id&#39;: &#39;81c3a0a2-b1e4-4211-9f18-fda5b90d6713&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T03:06:59.133-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;status&#39;: &#39;active&#39;,
    &#39;intent&#39;: &#39;order&#39;,
    &#39;medicationCodeableConcept&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://www.nlm.nih.gov/research/umls/rxnorm&#39;,
       &#39;code&#39;: &#39;315971&#39;,
       &#39;display&#39;: &#39;Lasix 40mg&#39;}],
     &#39;text&#39;: &#39;Lasix 40mg&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/f521ce2a-d1a0-45eb-a6cd-b584af886aa5&#39;},
    &#39;authoredOn&#39;: &#39;2009-06-30T06:29:54+00:00&#39;,
    &#39;requester&#39;: {&#39;reference&#39;: &#39;Practitioner/e34619ed-fc04-401f-a94c-1cf43395f4b3&#39;},
    &#39;reasonReference&#39;: [{&#39;reference&#39;: &#39;Condition/7446b6f9-7cc2-4692-8f5e-31e0de1b1a86&#39;}],
    &#39;dosageInstruction&#39;: [{&#39;sequence&#39;: 1,
      &#39;timing&#39;: {&#39;repeat&#39;: {&#39;frequency&#39;: 1, &#39;period&#39;: 1, &#39;periodUnit&#39;: &#39;d&#39;}},
      &#39;asNeededBoolean&#39;: False,
      &#39;doseAndRate&#39;: [{&#39;type&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/dose-rate-type&#39;,
           &#39;code&#39;: &#39;ordered&#39;,
           &#39;display&#39;: &#39;Ordered&#39;}]},
        &#39;doseQuantity&#39;: {&#39;value&#39;: 1}}]}]},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/MedicationRequest/a7913361-8c27-4138-97b6-8c5a14c0e3d1&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;MedicationRequest&#39;,
    &#39;id&#39;: &#39;a7913361-8c27-4138-97b6-8c5a14c0e3d1&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T03:06:33.434-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;status&#39;: &#39;stopped&#39;,
    &#39;intent&#39;: &#39;order&#39;,
    &#39;medicationCodeableConcept&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://www.nlm.nih.gov/research/umls/rxnorm&#39;,
       &#39;code&#39;: &#39;310436&#39;,
       &#39;display&#39;: &#39;Galantamine 4 MG Oral Tablet&#39;}],
     &#39;text&#39;: &#39;Galantamine 4 MG Oral Tablet&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/d36a505f-ee76-44eb-9374-3f4aacd336fa&#39;},
    &#39;authoredOn&#39;: &#39;2008-06-26T06:29:54+00:00&#39;,
    &#39;requester&#39;: {&#39;reference&#39;: &#39;Practitioner/e34619ed-fc04-401f-a94c-1cf43395f4b3&#39;},
    &#39;reasonReference&#39;: [{&#39;reference&#39;: &#39;Condition/9a459588-d2e2-4f83-8155-327757db91ed&#39;}]},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/MedicationRequest/d9107cdc-a490-4ece-bcd7-f81b733de3a1&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;MedicationRequest&#39;,
    &#39;id&#39;: &#39;d9107cdc-a490-4ece-bcd7-f81b733de3a1&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T03:05:12.253-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;status&#39;: &#39;active&#39;,
    &#39;intent&#39;: &#39;order&#39;,
    &#39;medicationCodeableConcept&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://www.nlm.nih.gov/research/umls/rxnorm&#39;,
       &#39;code&#39;: &#39;1719286&#39;,
       &#39;display&#39;: &#39;10 ML Furosemide 10 MG/ML Injection&#39;}],
     &#39;text&#39;: &#39;10 ML Furosemide 10 MG/ML Injection&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/89ca71e3-09b5-4654-a542-13b229e1afdf&#39;},
    &#39;authoredOn&#39;: &#39;2012-06-14T06:29:54+00:00&#39;,
    &#39;requester&#39;: {&#39;reference&#39;: &#39;Practitioner/e34619ed-fc04-401f-a94c-1cf43395f4b3&#39;},
    &#39;reasonReference&#39;: [{&#39;reference&#39;: &#39;Condition/7446b6f9-7cc2-4692-8f5e-31e0de1b1a86&#39;}]},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/MedicationRequest/dedd1721-6f56-47ee-a47f-bbb0df51fd39&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;MedicationRequest&#39;,
    &#39;id&#39;: &#39;dedd1721-6f56-47ee-a47f-bbb0df51fd39&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T03:04:31.421-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;status&#39;: &#39;active&#39;,
    &#39;intent&#39;: &#39;order&#39;,
    &#39;medicationCodeableConcept&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://www.nlm.nih.gov/research/umls/rxnorm&#39;,
       &#39;code&#39;: &#39;752899&#39;,
       &#39;display&#39;: &#39;0.25 ML Leuprolide Acetate 30 MG/ML Prefilled Syringe&#39;}],
     &#39;text&#39;: &#39;0.25 ML Leuprolide Acetate 30 MG/ML Prefilled Syringe&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/17cfc6f6-d19f-4624-a04f-835114b8b1a3&#39;},
    &#39;authoredOn&#39;: &#39;2004-05-28T06:29:54+00:00&#39;,
    &#39;requester&#39;: {&#39;reference&#39;: &#39;Practitioner/e34619ed-fc04-401f-a94c-1cf43395f4b3&#39;}},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/MedicationRequest/85417db3-c931-4a2d-9b21-8d677ffd4c1c&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;MedicationRequest&#39;,
    &#39;id&#39;: &#39;85417db3-c931-4a2d-9b21-8d677ffd4c1c&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T03:03:42.965-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;status&#39;: &#39;active&#39;,
    &#39;intent&#39;: &#39;order&#39;,
    &#39;medicationCodeableConcept&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://www.nlm.nih.gov/research/umls/rxnorm&#39;,
       &#39;code&#39;: &#39;996740&#39;,
       &#39;display&#39;: &#39;Memantine hydrochloride 2 MG/ML Oral Solution&#39;}],
     &#39;text&#39;: &#39;Memantine hydrochloride 2 MG/ML Oral Solution&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/dc092411-6bf2-4ed0-9c22-550f4f2054ab&#39;},
    &#39;authoredOn&#39;: &#39;2009-05-22T06:29:54+00:00&#39;,
    &#39;requester&#39;: {&#39;reference&#39;: &#39;Practitioner/e34619ed-fc04-401f-a94c-1cf43395f4b3&#39;},
    &#39;reasonReference&#39;: [{&#39;reference&#39;: &#39;Condition/9a459588-d2e2-4f83-8155-327757db91ed&#39;}]},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/MedicationRequest/882df5a7-6c0c-40ea-ac99-b9a935a25284&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;MedicationRequest&#39;,
    &#39;id&#39;: &#39;882df5a7-6c0c-40ea-ac99-b9a935a25284&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T03:01:27.156-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;status&#39;: &#39;active&#39;,
    &#39;intent&#39;: &#39;order&#39;,
    &#39;medicationCodeableConcept&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://www.nlm.nih.gov/research/umls/rxnorm&#39;,
       &#39;code&#39;: &#39;1803932&#39;,
       &#39;display&#39;: &#39;Leucovorin 100 MG Injection&#39;}],
     &#39;text&#39;: &#39;Leucovorin 100 MG Injection&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/b42a99f3-a901-44cd-8b0b-878906127395&#39;},
    &#39;authoredOn&#39;: &#39;1983-07-13T06:29:54+00:00&#39;,
    &#39;requester&#39;: {&#39;reference&#39;: &#39;Practitioner/e34619ed-fc04-401f-a94c-1cf43395f4b3&#39;}},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/MedicationRequest/282fea82-1319-461a-bf82-f93ba879f140&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;MedicationRequest&#39;,
    &#39;id&#39;: &#39;282fea82-1319-461a-bf82-f93ba879f140&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T03:00:25.035-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;status&#39;: &#39;active&#39;,
    &#39;intent&#39;: &#39;order&#39;,
    &#39;medicationCodeableConcept&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://www.nlm.nih.gov/research/umls/rxnorm&#39;,
       &#39;code&#39;: &#39;1736776&#39;,
       &#39;display&#39;: &#39;10 ML oxaliplatin 5 MG/ML Injection&#39;}],
     &#39;text&#39;: &#39;10 ML oxaliplatin 5 MG/ML Injection&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/b42a99f3-a901-44cd-8b0b-878906127395&#39;},
    &#39;authoredOn&#39;: &#39;1983-07-13T06:29:54+00:00&#39;,
    &#39;requester&#39;: {&#39;reference&#39;: &#39;Practitioner/e34619ed-fc04-401f-a94c-1cf43395f4b3&#39;}},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/MedicationRequest/0a9c0530-0a27-4af3-90f5-99a7da744956&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;MedicationRequest&#39;,
    &#39;id&#39;: &#39;0a9c0530-0a27-4af3-90f5-99a7da744956&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T02:57:13.122-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;status&#39;: &#39;active&#39;,
    &#39;intent&#39;: &#39;order&#39;,
    &#39;medicationCodeableConcept&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://www.nlm.nih.gov/research/umls/rxnorm&#39;,
       &#39;code&#39;: &#39;866414&#39;,
       &#39;display&#39;: &#39;24 HR metoprolol succinate 100 MG Extended Release Oral Tablet [Toprol]&#39;}],
     &#39;text&#39;: &#39;24 HR metoprolol succinate 100 MG Extended Release Oral Tablet [Toprol]&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/f521ce2a-d1a0-45eb-a6cd-b584af886aa5&#39;},
    &#39;authoredOn&#39;: &#39;2009-06-30T06:29:54+00:00&#39;,
    &#39;requester&#39;: {&#39;reference&#39;: &#39;Practitioner/e34619ed-fc04-401f-a94c-1cf43395f4b3&#39;},
    &#39;reasonReference&#39;: [{&#39;reference&#39;: &#39;Condition/7446b6f9-7cc2-4692-8f5e-31e0de1b1a86&#39;}],
    &#39;dosageInstruction&#39;: [{&#39;sequence&#39;: 1,
      &#39;timing&#39;: {&#39;repeat&#39;: {&#39;frequency&#39;: 1, &#39;period&#39;: 1, &#39;periodUnit&#39;: &#39;d&#39;}},
      &#39;asNeededBoolean&#39;: False,
      &#39;doseAndRate&#39;: [{&#39;type&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/dose-rate-type&#39;,
           &#39;code&#39;: &#39;ordered&#39;,
           &#39;display&#39;: &#39;Ordered&#39;}]},
        &#39;doseQuantity&#39;: {&#39;value&#39;: 1}}]}]},
   &#39;search&#39;: {&#39;mode&#39;: &#39;match&#39;},
   &#39;response&#39;: {&#39;status&#39;: &#39;200 OK&#39;, &#39;etag&#39;: &#39;W/&#34;4&#34;&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/Condition/9a459588-d2e2-4f83-8155-327757db91ed&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;Condition&#39;,
    &#39;id&#39;: &#39;9a459588-d2e2-4f83-8155-327757db91ed&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T03:03:42.943-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;clinicalStatus&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/condition-clinical&#39;,
       &#39;code&#39;: &#39;active&#39;}]},
    &#39;verificationStatus&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/condition-ver-status&#39;,
       &#39;code&#39;: &#39;confirmed&#39;}]},
    &#39;code&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://snomed.info/sct&#39;,
       &#39;code&#39;: &#39;26929004&#39;,
       &#39;display&#39;: &#34;Alzheimer&#39;s disease (disorder)&#34;}],
     &#39;text&#39;: &#34;Alzheimer&#39;s disease (disorder)&#34;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/d36a505f-ee76-44eb-9374-3f4aacd336fa&#39;},
    &#39;onsetDateTime&#39;: &#39;2008-06-26T06:29:54+00:00&#39;,
    &#39;recordedDate&#39;: &#39;2008-06-26T06:29:54+00:00&#39;}},
  {&#39;fullUrl&#39;: &#39;https://r4.smarthealthit.org/Condition/7446b6f9-7cc2-4692-8f5e-31e0de1b1a86&#39;,
   &#39;resource&#39;: {&#39;resourceType&#39;: &#39;Condition&#39;,
    &#39;id&#39;: &#39;7446b6f9-7cc2-4692-8f5e-31e0de1b1a86&#39;,
    &#39;meta&#39;: {&#39;versionId&#39;: &#39;4&#39;,
     &#39;lastUpdated&#39;: &#39;2021-04-07T02:57:13.099-04:00&#39;,
     &#39;tag&#39;: [{&#39;system&#39;: &#39;https://smarthealthit.org/tags&#39;,
       &#39;code&#39;: &#39;synthea-5-2019&#39;}]},
    &#39;clinicalStatus&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/condition-clinical&#39;,
       &#39;code&#39;: &#39;active&#39;}]},
    &#39;verificationStatus&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://terminology.hl7.org/CodeSystem/condition-ver-status&#39;,
       &#39;code&#39;: &#39;confirmed&#39;}]},
    &#39;code&#39;: {&#39;coding&#39;: [{&#39;system&#39;: &#39;http://snomed.info/sct&#39;,
       &#39;code&#39;: &#39;88805009&#39;,
       &#39;display&#39;: &#39;Chronic congestive heart failure (disorder)&#39;}],
     &#39;text&#39;: &#39;Chronic congestive heart failure (disorder)&#39;},
    &#39;subject&#39;: {&#39;reference&#39;: &#39;Patient/11f2b925-43b2-45e4-ac34-7811a9eb9c1b&#39;},
    &#39;encounter&#39;: {&#39;reference&#39;: &#39;Encounter/71079e69-28af-44ca-8ee6-6f33f097ad48&#39;},
    &#39;onsetDateTime&#39;: &#39;2009-06-09T06:29:54+00:00&#39;,
    &#39;recordedDate&#39;: &#39;2009-06-09T06:29:54+00:00&#39;}}]}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="What-should-we-do-about-&quot;bad&quot;-references?">What should we do about "bad" references?<a class="anchor-link" href="#What-should-we-do-about-&quot;bad&quot;-references?"> </a></h3><p>Some examples of "bad" references</p>
<ul>
<li>Invalid reference value  points to a server that doesn't exist</li>
<li>Server cant find resource by ID</li>
<li>Unknown reference format ...</li>
</ul>
<p>We could</p>
<ul>
<li>Raise an error as soon as we hit a bad reference<ul>
<li>you won't get any data if there is even 1 problem with a reference )o:</li>
</ul>
</li>
<li>Silently ignore problems and just get what we can<ul>
<li>you will know that references are missing (o: but won't know why )o:</li>
</ul>
</li>
<li>Build up a list of issues that can be retured with the patient bundle<ul>
<li>you can choose what to do about each kind of issue</li>
<li>TODO: this is probably the preferred option</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="save_single_patient_medication_bundle" class="doc_header"><code>save_single_patient_medication_bundle</code><a href="https://github.com/pete88b/vulcan_medication_bundle/tree/main/vulcan_medication_bundle/per_patient.py#L39" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>save_single_patient_medication_bundle</code>(<strong><code>bundle</code></strong>, <strong><code>output_path</code></strong>=<em><code>'data'</code></em>)</p>
</blockquote>
<p>Write a patient medication bundle to file.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can save the JSON bundle to file to pass on to the next step of the process (o:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">save_single_patient_medication_bundle</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Bundle saved to data/patient_medication_bundle_11f2b925-43b2-45e4-ac34-7811a9eb9c1b.json
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Bundle-cleanup">Bundle cleanup<a class="anchor-link" href="#Bundle-cleanup"> </a></h2><p>The result of <a href="/vulcan_medication_bundle/per_patient.html#create_single_patient_medication_bundle"><code>create_single_patient_medication_bundle</code></a> is a <code>collection</code>, so we need to remove <code>search</code> elements from each <code>entry</code>. This removes some validation errors reported by <a href="https://inferno.healthit.gov/validator/">https://inferno.healthit.gov/validator/</a> - thanks Mike (o:</p>
<p>TODO: Do we care what the <code>search</code> element is telling us? i.e. what if it's not <code>match</code>?</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="handle_entry_search" class="doc_header"><code>handle_entry_search</code><a href="https://github.com/pete88b/vulcan_medication_bundle/tree/main/vulcan_medication_bundle/per_patient.py#L52" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>handle_entry_search</code>(<strong><code>bundle</code></strong>)</p>
</blockquote>
<p>Remove <code>search</code> elements from each <code>entry</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Bundle-filtering">Bundle filtering<a class="anchor-link" href="#Bundle-filtering"> </a></h2><p>TODO: Moved to 20a_status_filter - clean this up</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Medication-status-filter">Medication status filter<a class="anchor-link" href="#Medication-status-filter"> </a></h3><p>Remove medication if the status tells us it was not or will not be taken.</p>
<ul>
<li><a href="https://www.hl7.org/fhir/valueset-medicationrequest-status.html">https://www.hl7.org/fhir/valueset-medicationrequest-status.html</a></li>
<li><a href="https://www.hl7.org/fhir/valueset-medicationdispense-status.html">https://www.hl7.org/fhir/valueset-medicationdispense-status.html</a></li>
<li><a href="https://www.hl7.org/fhir/valueset-medication-admin-status.html">https://www.hl7.org/fhir/valueset-medication-admin-status.html</a></li>
<li><a href="https://www.hl7.org/fhir/valueset-medication-statement-status.html">https://www.hl7.org/fhir/valueset-medication-statement-status.html</a></li>
</ul>
<h4 id="Statuses-that-we-want-to-remove-from-the-bundle">Statuses that we want to remove from the bundle<a class="anchor-link" href="#Statuses-that-we-want-to-remove-from-the-bundle"> </a></h4><ul>
<li>MedicationRequest (Include: active, on-hold, completed, entered-in-error, unknown)<ul>
<li>cancelled <ul>
<li>The prescription has been withdrawn before any administrations have occurred</li>
</ul>
</li>
<li>stopped <ul>
<li>Actions implied by the prescription are to be permanently halted, before all of the administrations occurred. </li>
<li>TODO: This is a ? <strong>halted, before all ...</strong> i.e. might some of the administrations occured</li>
</ul>
</li>
<li>draft<ul>
<li>The prescription is not yet 'actionable'</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>MedicationDispense (Include: on-hold, completed, unknown)</p>
<ul>
<li>preparation   <ul>
<li>The core event has not started yet, </li>
</ul>
</li>
<li>in-progress<ul>
<li>The dispensed product is ready for pickup</li>
</ul>
</li>
<li>cancelled <ul>
<li>The dispensed product was not and will never be picked up by the patient</li>
</ul>
</li>
<li>entered-in-error  <ul>
<li>The dispense was entered in error and therefore nullified</li>
</ul>
</li>
<li>stopped   <ul>
<li>Actions implied by the dispense have been permanently halted, before all of them occurred</li>
<li>TODO: This is a ? <strong>hatled, before all ...</strong> i.e. might some of the actions occured</li>
</ul>
</li>
<li>declined  <ul>
<li>The dispense was declined and not performed.</li>
</ul>
</li>
</ul>
</li>
<li><p>MedicationAdministration (Include: in-progress, on-hold, completed, stopped, unknown)</p>
<ul>
<li>not-done  <ul>
<li>The administration was terminated prior to any impact on the subject</li>
</ul>
</li>
<li>entered-in-error  <ul>
<li>The administration was entered in error and therefore nullified</li>
</ul>
</li>
</ul>
</li>
<li><p>MedicationStatement (Include: active, completed, entered-in-error, intended, stopped, on-hold, unknown)</p>
<ul>
<li>not-taken<ul>
<li>The medication was not consumed by the patient</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="What-if-these-statuses-are-not-appropriate-for-every-study?">What if these statuses are not appropriate for every study?<a class="anchor-link" href="#What-if-these-statuses-are-not-appropriate-for-every-study?"> </a></h4><p>It's possible that a study needs to see medication records confirming that a medication was not taken.</p>
<p>i.e. If previous treatment with a medication is an exclusion criteria, absense of a medication record might not be enough to be sure the patient didn't take it.</p>
<p>So we'll need to make filters configurable ...</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Should-we-always-run-the-status-filter?">Should we always run the status filter?<a class="anchor-link" href="#Should-we-always-run-the-status-filter?"> </a></h4><p>The CMOCCUR part of FHIR-to-CDISC Mappings xlsx includes status filtering instructions.</p>
<p>i.e We might not want to implement status filtering on the patient medication bundle.</p>
<p>So we'll need to make filters optional ...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="medication_status_filter" class="doc_header"><code>medication_status_filter</code><a href="https://github.com/pete88b/vulcan_medication_bundle/tree/main/vulcan_medication_bundle/per_patient.py#L59" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>medication_status_filter</code>(<strong><code>entry</code></strong>)</p>
</blockquote>
<p>Remove medications if the status tells us the medication was not or will not be taken</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="&quot;Do-Not-Perform&quot;-filter">"Do Not Perform" filter<a class="anchor-link" href="#&quot;Do-Not-Perform&quot;-filter"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="do_not_perform_filter" class="doc_header"><code>do_not_perform_filter</code><a href="https://github.com/pete88b/vulcan_medication_bundle/tree/main/vulcan_medication_bundle/per_patient.py#L75" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>do_not_perform_filter</code>(<strong><code>entry</code></strong>)</p>
</blockquote>
<p>Remove medications that have the <code>doNotPerform</code> flag set to true</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-medication-bundles-for-all-subjects-in-a-study">Create medication bundles for all subjects in a study<a class="anchor-link" href="#Create-medication-bundles-for-all-subjects-in-a-study"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When the HAPI FHIR server is available, we should be able to do something like</p>

<pre><code>api_base = 'http://hapi.fhir.org/baseR4'</code></pre>
<p>Find a patient in a study</p>

<pre><code>get_as_raw_json(api_base, 'ResearchSubject')</code></pre>
<p>List all resources associated with a study</p>

<pre><code>research_study_id = 1171831
# Note: &amp;_revinclude=* gives us everything refering to the study
get_as_raw_json(api_base, 'ResearchStudy', dict(_id=research_study_id, _revinclude='*'))</code></pre>
<p>Pick a patient from the above bundle and pull medication requests &darr;</p>

<pre><code># 'subject': {'reference': 'Patient/0c4a1143-8d1c-42ed-b509-eac97d77c9b2'
get_as_raw_json(api_base, 'MedicationRequest', dict(subject='0c4a1143-8d1c-42ed-b509-eac97d77c9b2'))</code></pre>
<p>Create medication bundles for all subjects in a study &darr;</p>

<pre><code>study_and_subject_bundle = get_as_raw_json(
        api_base, 'ResearchStudy', 
        dict(_id=research_study_id, _revinclude='ResearchSubject:study'))
for i, entry in enumerate(study_and_subject_bundle['entry']):
    resource = entry.get('resource', {})
    if resource.get('resourceType', 'unk') != 'ResearchSubject': continue
    patient_reference = resource.get('individual',{}).get('reference')[8:]
    bundle = create_single_patient_medication_bundle(api_base, patient_reference)
    bundle = handle_entry_search(bundle)
    bundle = filter_bundle(bundle, medication_status_filter)
    bundle = filter_bundle(bundle, do_not_perform_filter)
    save_single_patient_medication_bundle(bundle)
    if i&gt;1: break # stop early (o:</code></pre>
<p>Note: &uarr; We're starting to build a bundle processing pipeline (by adding calls to <a href="/vulcan_medication_bundle/per_patient.html#handle_entry_search"><code>handle_entry_search</code></a> and <a href="/vulcan_medication_bundle/core.html#filter_bundle"><code>filter_bundle</code></a>) - and we'll add more functions like this to remove non-concomitant medications etc</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Convert-FHIR-bundle-to-SDTM-csv">Convert FHIR bundle to SDTM csv<a class="anchor-link" href="#Convert-FHIR-bundle-to-SDTM-csv"> </a></h2><p>Jay Gustafson built <a href="https://mylinks-prod-sdtmtool.azurewebsites.net/TransformBundle">https://mylinks-prod-sdtmtool.azurewebsites.net/TransformBundle</a> that allows parsing a FHIR bundle into SDTM csv content.</p>
<p>Also, you can POST a raw json string to <a href="https://mylinks-prod-sdtmtool.azurewebsites.net/TransformBundle/Process">https://mylinks-prod-sdtmtool.azurewebsites.net/TransformBundle/Process</a> and it will return a JSON object containing the SDTM csv content in the following structure:</p>

<pre><code>{'cmcsv': '"STUDYID","DOMAIN","USUBJID",...\r\n"RWD-STUDY-01","CM","RWD-SUBJECT-01-30",...\r\n',
 'suppcmcsv': '"STUDYID","RDOMAIN","USUBJID","IDVAR","IDVARVAL","QNAM","QLABEL","QVAL"\r\n"RWD-STUDY-01","CM","RWD-SUBJECT-01-30","CMSEQ","1","CMSOURCE","Resource Name","MedicationRequest"\r\n...',
 'dmcsv': '"STUDYID","DOMAIN","USUBJID",...\r\n"RWD-STUDY-01","DM","RWD-SUBJECT-01-30",...\r\n'}</code></pre>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://mylinks-prod-sdtmtool.azurewebsites.net/TransformBundle/Process&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">bundle</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="View-the-response-as-a-table">View the response as a table<a class="anchor-link" href="#View-the-response-as-a-table"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;cmcsv&#39;</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>STUDYID</th>
      <th>DOMAIN</th>
      <th>USUBJID</th>
      <th>CMSEQ</th>
      <th>CMGRPID</th>
      <th>CMSPID</th>
      <th>CMTRT</th>
      <th>CMMODIFY</th>
      <th>CMDECOD</th>
      <th>CMCAT</th>
      <th>...</th>
      <th>CMENDTC</th>
      <th>CMSTDY</th>
      <th>CMENDY</th>
      <th>CMDUR</th>
      <th>CMSTRF</th>
      <th>CMENRF</th>
      <th>CMSTRTPT</th>
      <th>CMSTTPT</th>
      <th>CMENRTPT</th>
      <th>CMENTPT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>RWD-STUDY-01</td>
      <td>CM</td>
      <td>RWD-SUBJECT-01-30</td>
      <td>1</td>
      <td>1</td>
      <td>SPONSOR-1</td>
      <td>24hr nicotine transdermal patch</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CAT1</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>RWD-STUDY-01</td>
      <td>CM</td>
      <td>RWD-SUBJECT-01-30</td>
      <td>2</td>
      <td>1</td>
      <td>SPONSOR-2</td>
      <td>1 ML DOCEtaxel 20 MG/ML Injection</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CAT1</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>RWD-STUDY-01</td>
      <td>CM</td>
      <td>RWD-SUBJECT-01-30</td>
      <td>3</td>
      <td>1</td>
      <td>SPONSOR-3</td>
      <td>Lasix 40mg</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CAT1</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>RWD-STUDY-01</td>
      <td>CM</td>
      <td>RWD-SUBJECT-01-30</td>
      <td>4</td>
      <td>1</td>
      <td>SPONSOR-4</td>
      <td>Galantamine 4 MG Oral Tablet</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CAT1</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>RWD-STUDY-01</td>
      <td>CM</td>
      <td>RWD-SUBJECT-01-30</td>
      <td>5</td>
      <td>1</td>
      <td>SPONSOR-5</td>
      <td>10 ML Furosemide 10 MG/ML Injection</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CAT1</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5</th>
      <td>RWD-STUDY-01</td>
      <td>CM</td>
      <td>RWD-SUBJECT-01-30</td>
      <td>6</td>
      <td>1</td>
      <td>SPONSOR-6</td>
      <td>0.25 ML Leuprolide Acetate 30 MG/ML Prefilled ...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CAT1</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>RWD-STUDY-01</td>
      <td>CM</td>
      <td>RWD-SUBJECT-01-30</td>
      <td>7</td>
      <td>1</td>
      <td>SPONSOR-7</td>
      <td>Memantine hydrochloride 2 MG/ML Oral Solution</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CAT1</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7</th>
      <td>RWD-STUDY-01</td>
      <td>CM</td>
      <td>RWD-SUBJECT-01-30</td>
      <td>8</td>
      <td>1</td>
      <td>SPONSOR-8</td>
      <td>Leucovorin 100 MG Injection</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CAT1</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8</th>
      <td>RWD-STUDY-01</td>
      <td>CM</td>
      <td>RWD-SUBJECT-01-30</td>
      <td>9</td>
      <td>1</td>
      <td>SPONSOR-9</td>
      <td>10 ML oxaliplatin 5 MG/ML Injection</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CAT1</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>RWD-STUDY-01</td>
      <td>CM</td>
      <td>RWD-SUBJECT-01-30</td>
      <td>10</td>
      <td>1</td>
      <td>SPONSOR-10</td>
      <td>24 HR metoprolol succinate 100 MG Extended Rel...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>CAT1</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>10 rows  41 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

