---

title: Status Filter


keywords: fastai
sidebar: home_sidebar

summary: "Filter a bundle of medications by status."
description: "Filter a bundle of medications by status."
nb_path: "20a_status_filter.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 20a_status_filter.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Medication-status-filter">Medication status filter<a class="anchor-link" href="#Medication-status-filter"> </a></h3><p>Remove medication if the status tells us it was not or will not be taken.</p>
<ul>
<li><a href="https://www.hl7.org/fhir/valueset-medicationrequest-status.html">https://www.hl7.org/fhir/valueset-medicationrequest-status.html</a></li>
<li><a href="https://www.hl7.org/fhir/valueset-medicationdispense-status.html">https://www.hl7.org/fhir/valueset-medicationdispense-status.html</a></li>
<li><a href="https://www.hl7.org/fhir/valueset-medication-admin-status.html">https://www.hl7.org/fhir/valueset-medication-admin-status.html</a></li>
<li><a href="https://www.hl7.org/fhir/valueset-medication-statement-status.html">https://www.hl7.org/fhir/valueset-medication-statement-status.html</a></li>
</ul>
<h4 id="Statuses-that-we-want-to-remove-from-the-bundle">Statuses that we want to remove from the bundle<a class="anchor-link" href="#Statuses-that-we-want-to-remove-from-the-bundle"> </a></h4><h1 id="TODO:-update-using-med-status.xlsx-values">TODO: update using med-status.xlsx values<a class="anchor-link" href="#TODO:-update-using-med-status.xlsx-values"> </a></h1><ul>
<li>MedicationRequest (Include: active, on-hold, completed, entered-in-error, unknown)<ul>
<li>cancelled <ul>
<li>The prescription has been withdrawn before any administrations have occurred</li>
</ul>
</li>
<li>stopped <ul>
<li>Actions implied by the prescription are to be permanently halted, before all of the administrations occurred. </li>
<li>TODO: This is a ? <strong>halted, before all ...</strong> i.e. might some of the administrations occured</li>
</ul>
</li>
<li>draft<ul>
<li>The prescription is not yet 'actionable'</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>MedicationDispense (Include: on-hold, completed, unknown)</p>
<ul>
<li>preparation   <ul>
<li>The core event has not started yet, </li>
</ul>
</li>
<li>in-progress<ul>
<li>The dispensed product is ready for pickup</li>
</ul>
</li>
<li>cancelled <ul>
<li>The dispensed product was not and will never be picked up by the patient</li>
</ul>
</li>
<li>entered-in-error  <ul>
<li>The dispense was entered in error and therefore nullified</li>
</ul>
</li>
<li>stopped   <ul>
<li>Actions implied by the dispense have been permanently halted, before all of them occurred</li>
<li>TODO: This is a ? <strong>hatled, before all ...</strong> i.e. might some of the actions occured</li>
</ul>
</li>
<li>declined  <ul>
<li>The dispense was declined and not performed.</li>
</ul>
</li>
</ul>
</li>
<li><p>MedicationAdministration (Include: in-progress, on-hold, completed, stopped, unknown)</p>
<ul>
<li>not-done  <ul>
<li>The administration was terminated prior to any impact on the subject</li>
</ul>
</li>
<li>entered-in-error  <ul>
<li>The administration was entered in error and therefore nullified</li>
</ul>
</li>
</ul>
</li>
<li><p>MedicationStatement (Include: active, completed, entered-in-error, intended, stopped, on-hold, unknown)</p>
<ul>
<li>not-taken<ul>
<li>The medication was not consumed by the patient</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="What-if-these-statuses-are-not-appropriate-for-every-study?">What if these statuses are not appropriate for every study?<a class="anchor-link" href="#What-if-these-statuses-are-not-appropriate-for-every-study?"> </a></h4><p>It's possible that a study needs to see medication records confirming that a medication was not taken.</p>
<p>i.e. If previous treatment with a medication is an exclusion criteria, absense of a medication record might not be enough to be sure the patient didn't take it.</p>
<p>So we'll need to make filters configurable ...</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Should-we-always-run-the-status-filter?">Should we always run the status filter?<a class="anchor-link" href="#Should-we-always-run-the-status-filter?"> </a></h4><p>The CMOCCUR part of FHIR-to-CDISC Mappings xlsx includes status filtering instructions.</p>
<p>i.e We might not want to implement status filtering on the patient medication bundle.</p>
<p>So we'll need to make filters optional ...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_negated_list" class="doc_header"><code>get_negated_list</code><a href="https://github.com/pete88b/vulcan_medication_bundle/tree/main/vulcan_medication_bundle/status_filter.py#L21" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_negated_list</code>(<strong><code>bundle</code></strong>, <strong><code>exclude_status_map</code></strong>=<em><code>{'MedicationRequest': ['cancelled', 'entered-in-error', 'stopped', 'draft'], 'MedicationDispense': ['cancelled', 'entered-in-error', 'stopped', 'declined'], 'MedicationAdministration': ['not-done', 'entered-in-error'], 'MedicationStatement': ['entered-in-error', 'not-taken']}</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">get_negated_list</span><span class="p">({}),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># https://inferno.healthit.gov/validator/results</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{
  &#34;resourceType&#34;: &#34;List&#34;,
  &#34;id&#34;: &#34;b6c19ca6-3da4-423e-b8fe-6bf050b19b14&#34;,
  &#34;title&#34;: &#34;Negated list of medications&#34;,
  &#34;status&#34;: &#34;current&#34;,
  &#34;mode&#34;: &#34;snapshot&#34;,
  &#34;date&#34;: &#34;2021-09-15T10:54:01Z&#34;,
  &#34;note&#34;: [
    {
      &#34;text&#34;: &#34;Exclude status map: ```{&#39;MedicationRequest&#39;: [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;], &#39;MedicationDispense&#39;: [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;declined&#39;], &#39;MedicationAdministration&#39;: [&#39;not-done&#39;, &#39;entered-in-error&#39;], &#39;MedicationStatement&#39;: [&#39;entered-in-error&#39;, &#39;not-taken&#39;]}```&#34;
    }
  ]
}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test/patient_medication_bundle_2.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">get_negated_list</span><span class="p">(</span><span class="n">bundle</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># https://inferno.healthit.gov/validator/results</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{
  &#34;resourceType&#34;: &#34;List&#34;,
  &#34;id&#34;: &#34;d92d687f-d262-4817-8d59-731ad62e8c98&#34;,
  &#34;title&#34;: &#34;Negated list of medications&#34;,
  &#34;status&#34;: &#34;current&#34;,
  &#34;mode&#34;: &#34;snapshot&#34;,
  &#34;date&#34;: &#34;2021-09-15T10:54:01Z&#34;,
  &#34;entry&#34;: [
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/07f4d7c2-edef-45f2-b4cf-36bb2bf939cb&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/0c7eb3f2-96a6-4145-9c48-717adc11fa6b&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;draft&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/5f2c9f0e-0e27-4327-9367-a349269e5e86&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;cancelled&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/6d31fab3-e126-4a69-b794-5ea43eb5b390&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;entered-in-error&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/7b93e7c9-77db-494a-abd5-719bb41c3e09&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/8b48b81c-fe2e-4b5c-84c6-972771c3359c&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/9e5e22cb-61e4-462f-8d35-6611aa49749f&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/a366d63b-19b9-4af7-9768-e77b1dc01d61&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/b31fcab5-fa08-4de4-a8ee-4f732b70aea1&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/b6700297-af44-41ed-ab24-ed5a8161cfe6&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/b677e24b-e887-4fa7-8373-58cab5f3ca04&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/c4ced108-6b70-47fd-8f7b-14efabe0a597&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/ccc13aa2-863c-40b9-80e7-a2aba09ae661&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/d9fe4628-dacc-48cf-9b72-5392432c6aa5&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/f98b424c-3b68-4397-a1be-c0de7b7f325e&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/febcbbe9-7a01-4f0f-941f-a041db8335ba&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/test&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/test-3&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/test-p2&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationRequest/test-p2-3&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationRequest negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationDispense/meddisp0305&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationDispense negated as its status &#39;entered-in-error&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;declined&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationDispense/meddisp0309&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationDispense negated as its status &#39;entered-in-error&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;declined&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationDispense/meddisp0313&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationDispense negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;declined&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationDispense/meddisp0317&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationDispense negated as its status &#39;stopped&#39; is one of [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;declined&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationAdministration/medadmin0303&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationAdministration negated as its status &#39;entered-in-error&#39; is one of [&#39;not-done&#39;, &#39;entered-in-error&#39;]&#34;
      }
    },
    {
      &#34;item&#34;: {
        &#34;reference&#34;: &#34;https://server.fire.ly/r4/MedicationStatement/example005&#34;
      },
      &#34;flag&#34;: {
        &#34;text&#34;: &#34;MedicationStatement negated as its status &#39;entered-in-error&#39; is one of [&#39;entered-in-error&#39;, &#39;not-taken&#39;]&#34;
      }
    }
  ],
  &#34;note&#34;: [
    {
      &#34;text&#34;: &#34;Exclude status map: ```{&#39;MedicationRequest&#39;: [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;draft&#39;], &#39;MedicationDispense&#39;: [&#39;cancelled&#39;, &#39;entered-in-error&#39;, &#39;stopped&#39;, &#39;declined&#39;], &#39;MedicationAdministration&#39;: [&#39;not-done&#39;, &#39;entered-in-error&#39;], &#39;MedicationStatement&#39;: [&#39;entered-in-error&#39;, &#39;not-taken&#39;]}```&#34;
    }
  ]
}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

